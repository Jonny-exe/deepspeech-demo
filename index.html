<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>
  <script defer src="node_modules/@fortawesome/fontawesome-free/js/brands.js" type="application/javascript"></script>
  <script defer src="node_modules/@fortawesome/fontawesome-free/js/solid.js" type="application/javascript"></script>
  <script defer src="node_modules/@fortawesome/fontawesome-free/js/fontawesome.js"
    type="application/javascript"></script>
</head>

<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
  }

  #prediction {
    width: 90%;
    margin: 1%;
    font-size: 170%;
    opacity: .7;
  }

  #details {
    padding: 1%;
    opacity: .7;
    margin: 1%;
  }

  .hidden {
    display: None;
  }

  .btn {
    background: rgba(0, 0, 0, 0);
    border: none;
    padding: 1%;
    border-radius: 5px;
    transition-duration: .3s;
    margin: 1%;
  }

  .btn:hover {
    background: rgba(0, 0, 0, .1);
  }

  .buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    height: 50%;
  }

  #details {
    height: 0%;
    transition-duration: 0.5s;
  }

  .tall {
    height: 100% !important;
  }
</style>

<body>
  <div id="prediction"> Text </div>
  <div id="details" class="hidden">
    <table>
      <tr>
        <td id="confidence"></td>
      </tr>
    </table>
  </div>
  <button type="button" class="btn hidden" id="stop"><i class="fas fa-stop fa-lg"></i></button>
  <button type="button" class="btn" id="start"><i class="fas fa-play fa-lg"></i></button>
  <button type="button" class="btn" id="detail"><i class="fas fa-info-circle fg-lg"></i></button>
</body>
<script src="node_modules/socket.io/client-dist/socket.io.js"></script>
<script type="module" src="env.js" type="text/javascript"></script>
<script type="module">
  import PATH from './env.js'
  var socket = io("http://localhost/", { path: PATH })

  const stopButton = document.getElementById("stop");
  const startButton = document.getElementById("start");
  const detailButton = document.getElementById("detail");
  const detailsDiv = document.getElementById("details");
  detailButton.addEventListener("click", () => {
    detailsDiv.classList.toggle("hidden")
  })

  const handleSuccess = async function (stream) {
    const mediaRecorder = await new RecordRTC(stream, {
      type: 'audio',
      recorderType: RecordRTC.StereoAudioRecorder, // force for all browsers
      numberOfAudioChannels: 2
    });
    mediaRecorder.startRecording()
    stopButton.classList.remove("hidden")

    stopButton.addEventListener("click", async function () {
      stopButton.classList.add("hidden")
      await mediaRecorder.stopRecording(function () {
        let blob = mediaRecorder.getBlob();
        console.log(blob)
        socket.emit("file", blob)
      });
      startButton.classList.remove("hidden")
    });
  };

  startButton.addEventListener("click", () => {
    startButton.classList.add("hidden")
    navigator.mediaDevices
      .getUserMedia({ audio: true, video: false })
      .then(handleSuccess);
  })


  socket.on("prediction", function ({ text, confidence }) {
    console.log("result: ", text)
    document.getElementById("prediction").innerText = text
    document.getElementById("confidence").innerText = `Confidence: ${confidence}`
  })

</script>

</html>